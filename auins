#!/usr/bin/bash
# Author/Wechat: Auroot
# Script name: Auins (ArchLinux User Installation Scripts) 
# URL GitHub: https://github.com/Auroots/Auins
# URL Gitee : https://gitee.com/auroot/Auins
# set -xe
# set -eu
echo &>/dev/null
export AUINS_SCRIPT_NAME SOURCE_MODULES SOURCE_LOCAL TIME_ARCHISO SCRIPTS_SOURCE
export BOOT_TYPE DISK_TYPE CHROOT_PATTERNS_PRINT START_MODE AUINS_VERSION
export CONFIGURE_SYSTEM config_File info_File 

# @ script source
# auroot  |  gitee  |  github  |  test
SCRIPTS_SOURCE="auroot"
AUINS_VERSION="ArchLinux User Install Scripts v4.7.8" 
# sed -i.bak 's/^aaa=yes/aaa=no/' [file] # æ›¿æ¢å¹¶å¤‡ä»½

# @è„šæœ¬åˆå§‹åŒ–
function Auins_Variable_init(){
    Auins_Dir=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd )
    [ "$Auins_Dir" = "/" ] && Auins_Dir=""
    AUINS_SCRIPT_NAME=auins
    modules_Dir="${Auins_Dir}/modules" 
    local_Dir="${Auins_Dir}/local" 
    config_File="${local_Dir}/profile.conf"  
    info_File="${local_Dir}/auins.info"  
    Mirrorlist_modules="${modules_Dir}/mirrorlist_manage.sh"
    Users_modules="${modules_Dir}/users_manage.sh"
    Partition_modules="${modules_Dir}/partition_disk.sh"
    Desktop_modules="${modules_Dir}/desktop_manage.sh"
    Drive_modules="${modules_Dir}/drive_manage.sh"
    Fonts_modules="${modules_Dir}/fonts_manage.sh"
    Info_modules="${modules_Dir}/info_print.sh"
    Tools_modules="${modules_Dir}/tools_module.sh"
    Blarckarch_modules="${modules_Dir}/blackarch_strap.sh"
    System_Root="/mnt"
    Livecd_Version_Route="/run/archiso/airootfs/version"
    # entries_Boot="/sys/firmware/efi/efivars"  # discern: UEFI
    set +e
    [ ! -d "$local_Dir" ] && mkdir -p "$local_Dir"
    [ ! -d "$modules_Dir" ] && mkdir -p "$modules_Dir"
    [ ! -e "$config_File" ] && touch "$config_File"
    set -e
}

# check for root privilege
function check_priv(){
  if [ "$(id -u)" -ne 0 ]; then
    err(){ echo -e >&2 "\033[1;37m:: $(tput bold; tput setaf 1)[ x Error ] => \033[1;31m${*}\033[0m$(tput sgr0)"; exit 255; } 
    err "Please use command: \033[1;33m\"sudo\"\033[1;31m or user: \033[1;33m\"root\"\033[1;31m to execute.\033[0m"
  fi
}
# modulesæ¨¡å—ä½¿ç”¨æ–¹æ³•
# é•œåƒæºé…ç½®
function run_update_mirrors(){ 
    # éœ€è¦å¼•ç”¨: 1:é…ç½®æ–‡ä»¶, 2:ä¿¡æ¯æ–‡ä»¶
    bash "$Mirrorlist_modules" "$config_File" "$info_File" "$Tools_modules"
}
# ç”¨æˆ·é…ç½®
function run_configure_users(){ 
    # éœ€è¦å¼•ç”¨: 1:é…ç½®æ–‡ä»¶, 2:ä¿¡æ¯æ–‡ä»¶
    bash "$Users_modules" "$config_File" "$info_File" "$Tools_modules"
}
# ç£ç›˜åˆ†åŒº
function run_configure_partition(){
    # éœ€è¦å¼•ç”¨: 1:é…ç½®æ–‡ä»¶, 2:ä¿¡æ¯æ–‡ä»¶, 3:è¿›ç¨‹ç®¡ç†æ¨¡å—
    bash "$Partition_modules" "$config_File" "$info_File" "$Tools_modules" || exit 1; 
    bash "${0}"
}
# blackarché…ç½®æ¨¡å—, https://blackarch.org/strap.sh
function run_blarckarch_script(){ 
    bash "$Blarckarch_modules"
}
# æ¡Œé¢å®‰è£…ä¸é…ç½®
function run_configure_desktop(){ 
    # éœ€è¦å¼•ç”¨: 1:é…ç½®æ–‡ä»¶, 2:ä¿¡æ¯æ–‡ä»¶, 3:localç›®å½•åœ°å€, 4:ä¿¡æ¯æ‰“å°æ¨¡å—,  5:å­—ä½“å®‰è£…ä¸é…ç½®æ¨¡å—, 6:è¿›ç¨‹ç®¡ç†æ¨¡å—
    bash "$Desktop_modules" "$config_File" "$info_File" "$local_Dir" \
         "$Tools_modules" "$Info_modules" "$Fonts_modules"
    run_tools "tips_w" "Whether to install Common Drivers? [Y/n]?"
    case $(run_tools read) in
        [Yy]*) run_configure_drive ;;
        [Nn]*) run_tools process stop "$0" ;;
    esac
}
# æ¡Œé¢å®‰è£…ä¸é…ç½®
function run_configure_drive(){
    # éœ€è¦å¼•ç”¨: 1:é…ç½®æ–‡ä»¶, 2:ä¿¡æ¯æ–‡ä»¶
    bash "$Drive_modules" "$config_File" "$info_File" "$Tools_modules"
}
# å­—ä½“å®‰è£…ä¸é…ç½®
function run_configure_fonts(){
    # éœ€è¦å¼•ç”¨: 1:é…ç½®æ–‡ä»¶, 2:ä¿¡æ¯æ–‡ä»¶, 3:localç›®å½•åœ°å€, 4:ä¿¡æ¯æ‰“å°æ¨¡å—, 5:è¿›ç¨‹ç®¡ç†æ¨¡å—, 6:ç”¨æˆ·é€‰é¡¹,è¯´æ˜:
    # Config_file_install_fonts:   æ ¹æ®é…ç½®æ–‡ä»¶, å®‰è£…ç›¸åº”çš„å­—ä½“
    # User_options_install_fonts:  æ ¹æ®ç”¨æˆ·é€‰é¡¹, å®‰è£…ç›¸åº”çš„å­—ä½“, $2 = ç”¨æˆ·çš„é€‰é¡¹æœ‰: [all] [common] [adobe] [code]
    # Script_Runing_install_fonts: è„šæœ¬è¿è¡Œæ—¶, ç”±è„šæœ¬è‡ªåŠ¨åˆ¤æ–­, è‡ªåŠ¨å®‰è£…é…ç½®æ–‡ä»¶ä¸­çš„é€‰é¡¹, å¦å¤–è¯¢é—®æ˜¯å¦å®‰è£…å…¶ä»–
    bash "$Fonts_modules" "$config_File" "$info_File" "$local_Dir" \
         "$Tools_modules" "$Info_modules" "$1" "$2"
}
# å°å‹é‡å¤æ€§é«˜çš„æ¨¡å—è°ƒç”¨ç®¡ç†å™¨
function run_tools(){
    # éœ€è¦å¼•ç”¨: 1:é…ç½®æ–‡ä»¶, 2:ä¿¡æ¯æ–‡ä»¶, ä¸»é€‰é¡¹, å…¶ä»–é€‰é¡¹1, å…¶ä»–é€‰é¡¹3, å…¶ä»–é€‰é¡¹4, å…¶ä»–é€‰é¡¹5
        # ä¸»é€‰é¡¹:
            # warn  è­¦å‘Š [è¾“å‡ºä¿¡æ¯]
            # run   å¼€å§‹è¿è¡Œ [è¾“å‡ºä¿¡æ¯]     
            # skip  è·³è¿‡ [è¾“å‡ºä¿¡æ¯]
            # err   é”™è¯¯ [è¾“å‡ºä¿¡æ¯]
            # feed  ç»“æœæç¤º, 1:æ­£å¸¸ç»“æŸè¦æ˜¾ç¤ºçš„ä¿¡æ¯, 2:éæ­£å¸¸ç»“æŸè¦æ˜¾ç¤ºçš„ä¿¡æ¯
            # read  è·å–ç”¨æˆ·è¾“å…¥
            # ck_p  æ£€æŸ¥æƒé™,å¦‚æœéroot,åˆ™é€€å‡º
            # tips_w    æç¤ºè¾“å…¥-ç™½ [è¾“å‡ºä¿¡æ¯]
            # tips_y    æç¤ºè¾“å…¥-é»„ [è¾“å‡ºä¿¡æ¯]
            # file_rw   è¯»å†™æ–‡ä»¶ [INFO / CONF] [Read / Write] [å¤´éƒ¨å‚æ•°] [ä¿®æ”¹å†…å®¹(Write)]
            # mt_dir    åˆ›å»ºä¸´æ—¶ç›®å½•
            # show_Disk è¾“å‡ºç£ç›˜è¡¨åŠUUID
            # test_Disk æ£€æŸ¥ç£ç›˜åæ˜¯å¦åˆæ³• [ç£ç›˜å]
            # test_Part æ£€æŸ¥åˆ†åŒºåæ˜¯å¦åˆæ³• [åˆ†åŒºå]
            # process   è¿›ç¨‹ç®¡ç† 1:{start|restart|stop}, 2[è¿›ç¨‹å], 3:[éœ€è¦è¾“å‡ºçš„é”™è¯¯ä¿¡æ¯]
            # ip_api    ä½¿ç”¨apiè·å–ä¿¡æ¯  [æŸ¥è¯¢ä¿¡æ¯]:{region | country | country_code | timezone}
            # ipapi     ä½¿ç”¨apiè·å–ä¿¡æ¯  [æŸ¥è¯¢ä¿¡æ¯]:æ¯”ä»¥ä¸Šå¤šä¸€ä¸ªip,ä½†å¤„äºnull
            # ipinfo    ä½¿ç”¨apiè·å–ä¿¡æ¯(æ¨è)  [æŸ¥è¯¢ä¿¡æ¯]:{ip | country_code | timezone}
            # ipify     ä½¿ç”¨apiè·å–ä¿¡æ¯, ä»…ip
    bash "$Tools_modules" "$config_File" "$info_File" "$local_Dir" "$1" "$2" "$3" "$4" "$5"
}
# ä¿¡æ¯æ‰“å°
function run_print_info(){
    # éœ€è¦å¼•ç”¨: 1:é…ç½®æ–‡ä»¶, 2:ä¿¡æ¯æ–‡ä»¶, 3:ç”¨æˆ·é€‰é¡¹(ä»¥ä¸‹), 4:logosæ‰€éœ€1, 5:logosæ‰€éœ€2
    # version:    Auinsç‰ˆæœ¬ä¿¡æ¯, éœ€è¦æ¥æ”¶: auinusç‰ˆæœ¬ä¿¡æ¯
    # logos:      Scripté¦–é¡µä¿¡æ¯, éœ€è¦æ¥æ”¶: 1=ChrootçŠ¶æ€(CHROOT_PATTERNS_PRINT) 2=è„šæœ¬å¼€å¯æ¨¡å¼(START_MODE) 
    # ssh_info:   è¾“å‡ºSSHä¿¡æ¯
    # auins_usage:      Auinsçš„å¸®åŠ©æ–‡æ¡£ Auin_help, (æ— éœ€ä»»ä½•å‚æ•°)
    # livecd_home_list: LiveCDç¯å¢ƒä¸‹, é¦–é¡µä¼šæ˜¾ç¤ºçš„åˆ—è¡¨, (æ— éœ€ä»»ä½•å‚æ•°)
    # normal_home_list: æ­£å¸¸(Normal)ç¯å¢ƒä¸‹, é¦–é¡µä¼šæ˜¾ç¤ºçš„åˆ—è¡¨, (æ— éœ€ä»»ä½•å‚æ•°)
    # desktop_env_list: æ¡Œé¢ç¯å¢ƒçš„é€‰æ‹©åˆ—è¡¨, (æ— éœ€ä»»ä½•å‚æ•°)
    # desktop_manager_list:       æ¡Œé¢ç®¡ç†å™¨çš„é€‰æ‹©åˆ—è¡¨, (æ— éœ€ä»»ä½•å‚æ•°)
    # livecd_system_module_list:  é¦–é€‰é¡¹ [4] çš„åˆ—è¡¨, (æ— éœ€ä»»ä½•å‚æ•°)
    # install_system_info:        ç³»ç»Ÿå®‰è£…æˆåŠŸ, ç›´å¥”åŠ å…¥chrootçš„æç¤ºä¿¡æ¯, (æ— éœ€ä»»ä½•å‚æ•°)
    # config_system_info:         å®Œæˆç³»ç»Ÿé…ç½®æˆåŠŸ, å¯é‡å¯çš„æç¤ºä¿¡æ¯, (æ— éœ€ä»»ä½•å‚æ•°)
    # JetBrainsFira_font_usage:   JetBrainsFiraå­—ä½“å®‰è£…å®Œæˆåçš„ä½¿ç”¨è¯´æ˜, (æ— éœ€ä»»ä½•å‚æ•°)
    bash "$Info_modules" "$config_File" "$info_File" "$Tools_modules" "$1" "$2" "$3"
}

# @install Programs å®‰è£…åŒ…
function Install_Program() {
    # arch-chroot ${MNT_DIR} bash -c "$COMMAND"
    set +e
    IFS=' '; PACKAGES=("$@");
    for VARIABLE in {1..3}
    do
        local COMMAND="pacman -Syu --noconfirm --needed ${PACKAGES[@]}"
        if ! bash -c "$COMMAND" ; then
            break;
        else
            sleep 1.5; break;
        fi
    done
    echo "$VARIABLE" &> /dev/null
    set -e
}

# @è„šæœ¬è‡ªæ£€
function Script_init(){
    # Read Profile.conf
    CONF_Hostname=$(run_tools file_rw CONF Read Hostname)
    CONF_Password_SSH=$(run_tools file_rw CONF Read Password_SSH)
    CONF_Service_SSH=$(run_tools file_rw CONF Read Service_SSH)

    # å†™å…¥Auinsç‰ˆæœ¬
    run_tools file_rw INFO Write Auins_version "$AUINS_VERSION"

    # æŸ¥è¯¢å¹¶å†™å…¥CPUä¿¡æ¯
    CPU=$(head -n 5 /proc/cpuinfo | grep "model name" | awk -F ": " '{print $2}')
    lscpu | grep GenuineIntel &>/dev/null && CPU_Vendor="intel";
    lscpu | grep AuthenticAMD &>/dev/null && CPU_Vendor="amd";
    run_tools file_rw INFO Write CPU "$CPU"
    run_tools file_rw INFO Write CPU_Vendor "$CPU_Vendor"

    # æŸ¥è¯¢å¹¶å†™å…¥GPUä¿¡æ¯
    set +e
    not_intercept_gpu_info=$(lspci | grep -i VGA | awk -F ":" '{print $3}' | sed 's/^[ ]*//g')
    intercept_gpu_info=$(lspci  | grep -i VGA | awk -F ":" '{print $3}' | grep -o '\[.*\]')
    Unrecognized=$(echo -e "${white}Unrecognized${suffix}")
    GPU_Info_0="${intercept_gpu_info:-$not_intercept_gpu_info}"
    GPU="${GPU_Info_0:-$Unrecognized}"
    run_tools file_rw INFO Write GPU "$GPU"
    set -e

    Memory=$(($(sed -n '1,1p' /proc/meminfo | awk '{print $2}')/1000))
    run_tools file_rw INFO Write Memory "$Memory"

    # æŸ¥è¯¢å¹¶å†™å…¥ä¸»æœºç¯å¢ƒä¿¡æ¯
    lspci | grep -i "virtualbox" &>/dev/null && Host_Environment="VirtualBox";
    lspci | grep -i "vmware" &>/dev/null     && Host_Environment="Vmware"; 
    [[ $Host_Environment == "" ]] && Host_Environment="Computer"; SHOW_Host_Env=""
    run_tools file_rw INFO Write Host_Environment "$Host_Environment";

    # æŸ¥è¯¢å¹¶å†™å…¥Bootç±»å‹
    if [ -d /sys/firmware/efi ]; then
        BOOT_TYPE="UEFI" DISK_TYPE="GPT"
    else
        BOOT_TYPE="BIOS" DISK_TYPE="MBR"
    fi
    run_tools file_rw INFO Write Boot_Type ${BOOT_TYPE}
    run_tools file_rw INFO Write Disk_Type ${DISK_TYPE}
    INFO_Boot_way=$(run_tools file_rw INFO Read "Boot_Type")

    # æŸ¥è¯¢å¹¶å†™å…¥åœ°åŒº IP å›½å®¶
    CONF_Timezone=$(run_tools file_rw CONF Read Timezone)
    if [ -z "$CONF_Timezone" ] ; then
        # run_tools file_rw INFO Write Country "$(run_tools ipinfo "country")";
        run_tools file_rw INFO Write Timezone "$(run_tools ipinfo timezone)"
    else
        run_tools file_rw INFO Write Timezone "$CONF_Timezone";  
    fi
    # ä»apiä¸­è·å–ipï¼Œå›½å®¶ï¼Œæ—¶åŒºä¿¡æ¯ï¼Œå†™å…¥åˆ°infoæ–‡ä»¶ï¼Œæš‚æ—¶æ— å…¶ä»–ä½œç”¨
    run_tools file_rw INFO Write Public_IP "$(run_tools ipinfo ip)"
    run_tools file_rw INFO Write Country_Code "$(run_tools ipinfo country_code)"
    # æ ¡å‡†liveç¯å¢ƒçš„æ—¶é—´
    ln -sf "/usr/share/zoneinfo/$(run_tools file_rw INFO Read Timezone)" /etc/localtime &>/dev/null && hwclock --systohc --utc
     
     # æŸ¥è¯¢å¹¶å†™å…¥Chrootæ¨¡å¼
    if [ -d /run/archiso/airootfs ]; then 
        rm -rf "$local_Dir/Chroot_ON" &> /dev/null 
        rm -rf "$local_Dir/Not_Configure_System" &> /dev/null  
    else 
        touch "$local_Dir/Chroot_ON" &> /dev/null
    fi
    [ -e "$local_Dir/Chroot_ON" ] && CHROOT_PATTERNS_PRINT="Chroot-ON" || CHROOT_PATTERNS_PRINT="Chroot-OFF"; 

    [ -e "$local_Dir/Not_Configure_System" ] && CONFIGURE_SYSTEM="no" || CONFIGURE_SYSTEM="yes"; 
    run_tools file_rw INFO Write ChrootPatterns "$CHROOT_PATTERNS_PRINT";
    # Chroot-OFFä¸‹ï¼Œæ‰ä¼šè‡ªåŠ¨å¹²çš„äº‹æƒ…
    case "$CHROOT_PATTERNS_PRINT" in  
        Chroot-OFF) 
            # æ ¹æ®é…ç½®æ–‡ä»¶, åˆ¤æ–­æ˜¯å¦å¼€å¯SSHè¿œç¨‹æœåŠ¡, Chrootä¸‹ä¸æ‰§è¡Œ
            case $CONF_Service_SSH in [Yy]*) Open_SSH; esac
    esac
}

# @ä¸‹è½½æ‰€éœ€çš„è„šæœ¬æ¨¡å—
function Update_Share(){     
    # feedback successfully info
    function feed_status(){ 
        if [ $? = 0 ]; then 
            echo -e "\033[1;37m:: $(tput bold; tput setaf 2)=> \033[1;32m${1}\033[0m$(tput sgr0)"; 
        else 
            err "$2"
        fi
    }
    # æ ¹æ®é…ç½®æ–‡ä»¶é€‰æ‹©æº, å°†å…¶ä½œä¸ºè„šæœ¬çš„ä¸‹è½½æº Module URL: Default settings
    function auins_download_url(){
        case ${1} in
            "gitee"  ) SOURCE="https://gitee.com/auroot/Auins/raw/main" ;;
            "github" ) SOURCE="https://raw.githubusercontent.com/Auroots/Auins/main";;
            "auroot" ) SOURCE="http://auins.auroot.cn" ;;
            "test"   ) SOURCE="http://test.auroot.cn" 
        esac
        SOURCE_MODULES="${SOURCE}/modules"
        SOURCE_LOCAL="${SOURCE}/local"
    }
    # æ£€æŸ¥ä¸å®¡æ ¸æ–‡ä»¶æ˜¯å¦å­˜åœ¨æˆ–ä¸ºç©º, 1.å¦‚æœä¸å­˜åœ¨åˆ™ä¸‹è½½, 2.å¦‚æœä¸ºç©ºåˆ™åˆ é™¤, 3,å¦‚æœæœ¬åœ°ä¸äº‘ç«¯ä¸ä¸€è‡´å°†è‡ªåŠ¨æ›´æ–°
    function audit_file() {
        local directory=$1; file_path=$2; file_name=$(echo "$file_path" | awk -F"/" '{print $NF}')
        case $directory in 
            [Mm]*) SOURCE_URL="${SOURCE}/modules";;
            [Ll]*) SOURCE_URL="${SOURCE}/local"
        esac
        if [ -z "$(cat "$config_File")" ]; then
            Profile_name=$(echo "$config_File" | awk -F"/" '{print $NF}')
            curl -fsSL "${SOURCE}/local/${Profile_name}" > "$config_File"
            feed_status "Successfully download: [${white} ${Profile_name} ${green}]" "Download failed: [${white} ${Profile_name} ${red}]";
        fi
        if [ ! -e "$file_path" ]; then
            curl -fsSL "${SOURCE_URL}/${file_name}" > "$file_path"  
            feed_status "Successfully download: [${white} $file_name ${green}]" "Download failed: [${white} $file_name ${red}]";
            case $(echo "$file_name" | awk -F"." '{print $NF}') in 
                sh) chmod +x "$file_path" || if [ -z "$(cat "$file_path")" ]; then rm -f "$file_path"; fi
            esac      
        fi
        case $(run_tools file_rw CONF Read Now_update_auins 2>/dev/null) in
            [Yy]*)
                    if [[ $file_name != "$(echo "$info_File" | awk -F"/" '{print $NF}')" ]] \
                    && [[ $file_name != "$(echo "$config_File" | awk -F"/" '{print $NF}')" ]]; then
                        if [[ "$(cat "$file_path")" != "$(curl -fsSL "${SOURCE_URL}/${file_name}")" ]]; then 
                            curl -fsSL "${SOURCE_URL}/${file_name}" > "$file_path"
                            feed_status "Successfully update: [${white} $file_name ${green}]" "Update failed: [${white} $file_name ${red}]";
                        fi
                    fi 
                ;;
        esac 
    }
    # ä¸‹è½½æƒ³è¦è„šæœ¬æ¨¡å— 
    function download_script(){
        audit_file local "$config_File"
        audit_file local "$info_File"
        audit_file modules "$Tools_modules"
        audit_file modules "$Info_modules"  
        audit_file modules "$Mirrorlist_modules"
        audit_file modules "$Users_modules"
        audit_file modules "$Partition_modules"
        audit_file modules "$Desktop_modules"
        audit_file modules "$Fonts_modules"
        audit_file modules "$Blarckarch_modules"
        audit_file modules "$Drive_modules"
        run_tools file_rw CONF Write modules_source "$SOURCE_MODULES"
        run_tools file_rw CONF Write local_source "$SOURCE_LOCAL"
        # æ›´æ–°auins
        case $(run_tools file_rw CONF Read Now_update_auins) in
        [Yy]*)
            if [[ "$(cat "$0")" != "$(curl -fsSL "${SOURCE}/${AUINS_SCRIPT_NAME}")" ]]; then 
                curl -fsSL "${SOURCE}/${AUINS_SCRIPT_NAME}" > "$0"
                feed_status "Successfully update: [${white} Auins ${green}]" "Update failed: [${white} Auins ${red}]" && exit 0;
            fi
        esac
    }
    
    case ${1} in
        "auins_download_url") auins_download_url "$2";;
        "download_script") download_script 
    esac
}

# @ç½‘ç»œéƒ¨åˆ†é›†åˆ
function Network(){
    # info_all_nic=$(awk '{if($1>0 && NR > 2) print substr($1, 0, index($1, ":") - 1)}' /proc/net/dev)
    info_all_nic=$(awk '{if($1>0 && NR > 2) print substr($1, 0, index($1, ":") - 1)}' /proc/net/dev | sed '/lo/d' | sed '/vi/d')
    declare -A NET_Interface=()
    declare -A NET_IP=()
    Show_Network(){
        local VARIABLE
        case $1 in 
            WIFI )  Show="^wl*"; 
        ;;  ETHERNET ) Show="^en*|^et*"; 
        esac
        for  ((VARIABLE=1;VARIABLE<=10;VARIABLE++)); do
            if echo "$info_all_nic" | grep -E "$Show" &>/dev/null ; then 
                Temp_name=$(echo "$info_all_nic" | grep -E "$Show" |  sed -n "$VARIABLE,1p" | sed 's/^[ ]*//g') 
                if [[ $Temp_name == "" ]]; then
                    break;
                else
                    LOCAL_IP=$(ip route list | grep "$Temp_name" | cut -d" " -f9 | sed -n '2, 1p')
                fi
                NET_Interface[$VARIABLE]=$Temp_name
                NET_IP[$Temp_name]=$LOCAL_IP
            else  # å½“WIFIæˆ–Ethrnetå…¶ä¸­ä¸€ä¸ªè®¾å¤‡ä¸å­˜åœ¨æ—¶,å°†è¾“å‡ºvoid,ç¡®ä¿å®Œæ•´æ€§
                if [[ $1 == "WIFI" ]]; then
                    NET_Interface=([1]=void)
                    NET_IP=([void]=void)
                else
                    NET_Interface=([1]=void)
                    NET_IP=([void]=void)
                fi
            fi
        done
        # æ ¼å¼åŒ–ç½‘å¡ä¸IP
        for ((VARIABLE=1;VARIABLE<=8;VARIABLE++)); do 
            NAME_TEMP=${NET_Interface[$VARIABLE]};
            if [[ $NAME_TEMP != "" ]]; then
                if [[ "${NET_IP[$NAME_TEMP]}" != "" ]]; then
                    NET_IP_TEMP=${NET_IP[$NAME_TEMP]};
                else
                    NET_IP_TEMP="void";
                fi 
                echo -n "$NAME_TEMP:${NET_IP_TEMP} | " ;
            else
                break;
            fi
        done; 
    }
    # @è·å–æœ¬æœºIPåœ°å€ï¼Œå¹¶å‚¨å­˜åˆ°$info_Fileï¼Œ Network Variable
    function ethernet_info(){    
        local Temp_name VARIABLE

        function NET_LIST(){
            for ((VARIABLE=1;VARIABLE<=$(echo "$1" | grep -o '|' | wc -l);VARIABLE++)) 
            do 
                list=$(echo "$1" | awk -F'|' '{print $test}' test="$VARIABLE" | sed 's/^[ ]*//g')
                list_ip=$(echo "$list" | awk -F':' '{print $2}')
                if [[ $list_ip != "" ]]; then 
                    PRINT_NET_Interface=$(echo "$list" | awk -F':' '{print $1}')
                    PRINT_NET_IP=$list_ip
                    echo -e "\t${VARIABLE}: ${PRINT_NET_Interface} - ${PRINT_NET_IP}"
                fi 
            done
        }
        
        run_tools file_rw INFO Write Wifi "$(Show_Network WIFI)"
        run_tools file_rw INFO Write Ethernet "$(Show_Network ETHERNET)"

        case $1 in 
            WIFI )  
                    echo -e "\033[1;37m:: $(tput bold; tput setaf 2)\033[1;36mWIFI: \n\033[1;37m$(NET_LIST "$(Show_Network WIFI)")\033[0m$(tput sgr0)"
        ;;  ETHERNET ) 
                    echo -e "\033[1;37m:: $(tput bold; tput setaf 2)\033[1;36mETHERNET: \n\033[1;37m$(NET_LIST "$(Show_Network ETHERNET)")\033[0m$(tput sgr0)"
        ;;  * )
        esac 
    }
    # @é…ç½®WIFIï¼ŒConfigure WIFI
    # https://wiki.archlinuxcn.org/wiki/%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/%E6%97%A0%E7%BA%BF%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE
    function configure_wifi() {
        # æ˜¾ç¤ºç½‘å¡ä¿¡æ¯: 1: wlan0 - void(ip)
        run_tools run "Checking the currently available network..."
        echo; Network ethernet_info WIFI; echo;
        # ç”¨æˆ·é€‰æ‹©ç½‘å¡
        run_tools tips_w "Please select WiFi interface [1,2,3...]?"
        WIFI_user_number=$(run_tools read)
        Show_Network WIFI &>/dev/null
        WIFI_Interface=${NET_Interface[$WIFI_user_number]}
        [[ $WIFI_Interface == "" ]] && run_tools err "This interface was not found."
        # æ‰“å°WIFIåˆ—è¡¨
        WIFI_INFO=$(iwlist "$WIFI_Interface" scan)
        run_tools feed "[ $WIFI_Interface ] Interface scan successful." 
        # æ¯”è¾ƒè¯¦ç»†çš„wifiåˆ—è¡¨
        echo -e "${white}:: ${blue}A detailed WiFi list:${suffix}"
        echo -e "${white}$(echo "$WIFI_INFO" | sed 's/^[ ]*//g' | grep -Ew "^ESSID*|^Frequency*|^Quality*" | \
        sed -e 's/^F/\\n   F/g' -e 's/^E/   E/g' -e 's/^Q/   Q/g')${suffix}\n"
        # åªæœ‰wifiåç§°çš„åˆ—è¡¨
        echo -e "${white}:: ${blue}A simple WiFi list:${suffix}\n"
        echo -e "${white}$(echo "$WIFI_INFO" | sed 's/^[ ]*//g' | grep -Ew "^ESSID*" | sed -e 's/^E/   E/g' )${suffix}\n"
        # ç”¨æˆ·è¾“å…¥WIFIåç§°
        run_tools tips_w "Enter wifi name(SSID)?"
        WIFI_ESSID=$(run_tools read)
        # ç”¨æˆ·è¾“å…¥WIFIå¯†ç 
        run_tools tips_w "Wifi Password"
        WIFI_PASSWD=$(run_tools read)
        # æ ¹æ®ç”¨æˆ·è¾“å…¥, å°è¯•è¿æ¥ç½‘ç»œ
        iwctl --passphrase "$WIFI_PASSWD" station "$WIFI_Interface" connect "$WIFI_ESSID"
        run_tools feed "Successfully connected to WiFi: [${white} $WIFI_ESSID ${green}]" \
        "Please check if the input is correct: SSID(${white}$WIFI_ESSID${red}) and password (${white}$WIFI_PASSWD${red})."

        ip address show "${WIFI_Interface}"
        if ! ping -c 3 61.166.150.123; then
            run_tools process stop "$0" "Network ping check failed. Cannot continue."
        fi
    }
    # @é…ç½®æœ‰çº¿ç½‘ç»œï¼ŒConfigure Ethernet.
    function configure_ethernet(){
        # æ˜¾ç¤ºç½‘å¡ä¿¡æ¯: 1: enp5s0 - 192.168.101.3(ip)
        run_tools run "Checking the currently available network..."
        Network ethernet_info ETHERNET

        run_tools tips_w "Please select Ethernet interface [1,2,3...]?"
        Ethernet_user_number=$(run_tools read)
        Show_Network ETHERNET &> /dev/null 
        Ethernet_Interface=${NET_Interface[$Ethernet_user_number]}

        run_tools feed ":: One moment please..."
        ip link set "${Ethernet_Interface}" up
        ip address show "${Ethernet_Interface}"
        if ! ping -c 3 61.166.150.123; then
            run_tools process stop "$0" "Network ping check failed. Cannot continue."
        fi
    }
    # @é…ç½®ç½‘ç»œ
    function configure_all(){
        run_tools tips_w "Query Network: Ethernet[1] Wifi[2] Exit[q]?"
        case $(run_tools read) in
            1 ) configure_ethernet ;;
            2 ) configure_wifi ;;
            [Qq]* ) bash "${0}"
        esac
    }
    # Ethernet
    case ${1} in
        ethernet_info ) ethernet_info "$2" ;;
        Conf_wifi) configure_wifi ;;
        Conf_Eth ) configure_ethernet ;;
        Conf_all ) configure_all
    esac
}

# @å¼€å¯SSHæœåŠ¡ï¼Œ Start ssh service 
function Open_SSH(){
    clear;
    run_tools run "Checking the currently available network..."
    Network ethernet_info WIFI 
    Network ethernet_info ETHERNET
    echo; echo "${USER}:${CONF_Password_SSH}" | chpasswd &>/dev/null 
    systemctl start sshd.service
    run_print_info ssh_info 
}

# @è®¾ç½®rootå¯†ç  ç”¨æˆ· 
function Configure_users2passwd(){
    local raw_number
    export INFO_UserName UsersID CheckingID CheckingUsers
    INFO_UserName=$(run_tools file_rw INFO Read "Users")
    INFO_UsersID=$(run_tools file_rw INFO Read "UsersID")
    CheckingUsers=""
    if [ -z "$INFO_UserName" ]; then
        for raw_number in {1..25}; do  
            Query=$(tail -n "${raw_number}" /etc/passwd | head -n 1 | cut -d":" -f3)
            if [ "$Query" -gt 999 ] && [ "$Query" -lt 1020 ]; then
                CheckingID=$(grep "$Query" < /etc/passwd | cut -d":" -f3)
                CheckingUsers=$(id -un "$CheckingID" 2> /dev/null)
                break;
            fi
        done
        if [[ -z "$CheckingUsers" ]] ; then
            run_configure_users
            INFO_UserName=$(run_tools file_rw INFO Read "Users")
            INFO_UsersID=$(run_tools file_rw INFO Read "UsersID")
            printf "${outG} ${green}A normal user already exists, The UserName:${suffix} ${blue}%s${suffix} ${green}ID: ${blue}%s${suffix}.\n"  "${INFO_UserName:-$CheckingUsers}" "${INFO_UsersID:-$CheckingID}"
        fi
    fi
    printf "${outG} ${green}A normal user already exists, The UserName:${suffix} ${blue}%s${suffix} ${green}ID: ${blue}%s${suffix}.\n"  "${INFO_UserName:-$CheckingUsers}" "${INFO_UsersID:-$CheckingID}"
    sleep 1.5
}

# @å®‰è£…ç³»ç»Ÿã€å†…æ ¸ã€åŸºç¡€åŒ…ç­‰ï¼ŒInstall system kernel / base...
function Install_Archlinux(){    
    CONF_Linux_kernel=$(run_tools file_rw CONF Read "Linux_kernel")
    run_tools run Update the system clock.  # update time
    timedatectl set-ntp true
    run_tools run Install the Kernel base packages.
    case "$CONF_Linux_kernel" in 
        linux    ) pacstrap "$System_Root" base base-devel reflector linux-firmware linux linux-headers linux-api-headers vim unzip  ;;
        linux-lts) pacstrap "$System_Root" base base-devel reflector linux-firmware linux-lts linux-lts-headers vim unzip ;; 
        linux-zen) pacstrap "$System_Root" base base-devel reflector linux-firmware linux-zen linux-zen-headers vim unzip
    esac
    run_tools feed "The installation of the kernel basic package was successful." \
    "The installation of the kernel basic package failed. \n${white}:: Suggest remount the disk or restart the system.${suffix}"

    run_tools run Configure fstab.
    genfstab -U $System_Root >> $System_Root/etc/fstab
    run_tools feed "Fstab configuration successful." "Fstab configuration failed."
    LinuxKernel=$(arch-chroot $System_Root /usr/bin/uname -a | /usr/bin/cut -d"#" -f1  | awk -F " " '{print $3}')
    run_tools file_rw INFO Write LinuxKernel "$LinuxKernel";
    cp -rf "$local_Dir" $System_Root/root/ 
    run_tools feed "$local_Dir directory copy successful." "$local_Dir directory copy failed."
    touch $System_Root/root/local/Chroot_ON
    run_tools feed "Chroot_ON file creation successful." "Chroot_ON file creation failed."
    touch $System_Root/root/local/Not_Configure_System 
    run_tools feed "Not_Configure_System file creation successful." "Not_Configure_System file creation failed."
}

# @Chroot -> $System_Root
function Auins_chroot(){    
    cat "$0" > $System_Root/root/$AUINS_SCRIPT_NAME 
    run_tools feed "$0 copy successful." "$0 copy failed."
    chmod +x $System_Root/root/$AUINS_SCRIPT_NAME 

    cp -f "$local_Dir/profile.conf"  $System_Root/root/local/
    run_tools feed "$local_Dir/profile.conf file copy successful." "$local_Dir/profile.conf file copy failed."

    cp -rf "$modules_Dir" $System_Root/root/ 2> /dev/null
    run_tools feed "$modules_Dir directory copy successful." "$modules_Dir directory copy failed."

    arch-chroot $System_Root /bin/bash -c "/root/$AUINS_SCRIPT_NAME"
}

# @å®‰è£… fcitx è¾“å…¥æ³•
function Configure_fcitx(){
    CONF_PKG_Fcitx=$(run_tools file_rw CONF Read "PKG_Fcitx")
    function install(){
        CONF_Install_Fcitx=$(run_tools file_rw CONF Read "Install_Fcitx")
        function install_fcitx(){
            run_tools run "Installing [ Fcitx ]."
            pacman -Rsc --noconfirm fcitx
            Install_Program "$CONF_PKG_Fcitx" 
            run_tools feed "fcitx installation successfully." "fcitx installation failed."
            Fcitx_Config="
GTK_IM_MODULE=fcitx
QT_IM_MODULE=fcitx
XMODIFIERS=@im=fcitx"
            echo "$Fcitx_Config" >> /etc/environment
        }

        case $CONF_Install_Fcitx in
            [Yy]* ) install_fcitx;; 
                * ) run_tools tips_w "Whether to install fcitx [Y/n]?"
                    case $(run_tools read) in
                        [Yy]*)  install_fcitx ;;
                            *)  run_tools skip "Install [ Fcitx ]".
                    esac
        esac 
    }
    function remove(){
        # awk '/fcitx/{print NR}' /etc/environment
        sed -i '/fcitx/d' /etc/environment
        pacman -Rsc --noconfirm "$CONF_PKG_Fcitx"
    }
    case $1 in 
        -R) remove; 
            status="flase" ;;
         *) run_tools warn "Input error or the option does not exist."; 
            status="true"
    esac
    [[ ${status} != "true" ]] && install; 
}

# @å®‰è£… ibus-rime è¾“å…¥æ³•
function Configure_ibus_rime() {
    CONF_PKG_Ibus=$(run_tools file_rw CONF Read "PKG_Ibus")
    function install(){
        CONF_Install_Ibus=$(run_tools file_rw CONF Read "Install_Ibus")
        function configure_ibus() {
            if wget -P "$local_Dir" "${SOURCE_LOCAL}/oh-my-rime.zip" ; then
                mkdir -p /home/"$INFO_UserName"/.config/ibus 
                unzip -d /home/"$INFO_UserName"/.config/ibus "${local_Dir}/oh-my-rime.zip"
            fi
            Ibus_Config="
export GTK_IM_MODULE=ibus
export XMODIFIERS=@im=ibus
export QT_IM_MODULE=ibus
ibus-daemon -d -x"
            echo "$Ibus_Config" >> /etc/environment
            echo "$Ibus_Config" >> /etc/profile
        }
        
        case $CONF_Install_Ibus in
            [Yy]*)  run_tools run "Installing [ ibus-rime ]."
                    Install_Program "$CONF_PKG_Ibus" 
                    run_tools feed "ibus-rime installation successfully." "ibus-rime installation failed."
                    configure_ibus;;
                *)  run_tools tips_w "Whether to install ibus-rime. [Y/n]?"
                    case $(run_tools read) in
                        [Yy]*)  run_tools run "Installing [ ibus-rime ]."
                                Install_Program "$CONF_PKG_Ibus" 
                                run_tools feed "ibus-rime installation successfully." "ibus-rime installation failed."
                                configure_ibus;;
                            *) run_tools skip "Install [ ibus-rime ]."
                    esac
        esac 
    }
    function remove(){
        # awk '/ibus/{print NR}' /etc/environment
        sed -i '/ibus/d' /etc/environment
        sed -i '/ibus/d' /etc/profile
        rm -rf "$HOME"/.config/ibus
        pacman -Rsc --noconfirm "$CONF_PKG_Ibus"
    }
    case $1 in 
        -R) remove && status="flase" ;;
        * ) run_tools warn "Input error or the option does not exist." && status="true"
    esac
    [[ ${status} != "true" ]] && install; 
}

# @Pacman multi threaded download [Axel]
function Axel_Configure() {
    Read_Axel_Thread=$(run_tools file_rw CONF Read "Axel_Thread")
    Axel="XferCommand = \/usr\/bin\/axel -n $Read_Axel_Thread -a -o %o %u"
    case $1 in 
        -R) rm -rf /etc/axelrc
            sed -i "s/$Axel/ /g" /etc/pacman.conf
            pacman -R axel
            status="flase"
    ;;
        * ) #run_tools warn "Input error or the option does not exist."
            status="true"
    esac
    if [[ ${status} == true ]]; then
        pacman -S --noconfirm --needed axel
        run_tools feed "axel installation successfully." "axel installation failed."
        echo "alternate_output = 1" > /etc/axelrc
        sed -i "/XferCommand = \/usr\/bin\/curl/i ${Axel}" /etc/pacman.conf
    fi
}

# @Install/Configure Grub, å®‰è£…å¹¶é…ç½®Grub
function Configure_Grub(){
    run_tools run "Install grub tools."
    run_tools run "Your startup mode has been detected as ${green}$INFO_Boot_way${suffix}."   
    CONF_PKG_GRUB_UEFI="$(run_tools file_rw CONF Read "PGK_GRUB_UEFI")"
    CONF_PKG_GRUB_BOOT="$(run_tools file_rw CONF Read "PGK_GRUB_BOOT")"

    case "$INFO_Boot_way" in 
        UEFI)
            Install_Program "$CONF_PKG_GRUB_UEFI"
            run_tools feed "Grub uefi base package installation successfully." "Grub uefi base package installation failed."
            grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id="$CONF_Hostname" --recheck
            echo "GRUB_DISABLE_OS_PROBER=false" >> /etc/default/grub
            grub-mkconfig -o /boot/grub/grub.cfg
            if efibootmgr | grep "$CONF_Hostname" &>/dev/null ; then
                run_tools run "Grub installed successfully -=> [${white} $CONF_Hostname ${green}]"  
                echo -e "${white}     $(efibootmgr | grep "$CONF_Hostname")  ${suffix}\n"  
            else
                echo -e "${yellow}     $(efibootmgr)  ${suffix}\n"
                run_tools err "Grub installed failed."
            fi
        ;;
        BIOS)
            Install_Program "$CONF_PKG_GRUB_BOOT"
            run_tools feed "Grub boot base package installation successfully." "Grub boot base package installation failed."
            local INFO_Boot_partition
            INFO_Boot_partition=$(run_tools file_rw INFO Read "Boot_partition") 
            grub-install --target=i386-pc --recheck --force "$INFO_Boot_partition"
            grub-mkconfig -o /boot/grub/grub.cfg
            if echo $? &>/dev/null ; then
                run_tools run "Grub installed successfully -=> [${white} $CONF_Hostname ${green}]" 
            else
                run_tools err "Grub installed failed."
            fi
    esac  
}

# @é…ç½®æœ¬åœ°åŒ– æ—¶åŒº ä¸»æœºå è¯­éŸ³ç­‰  
function Configure_Language(){
    language="LANG=en_US.UTF-8"
        run_tools run "Time zone changed to 'Shanghai'."
    ln -sf /usr/share/zoneinfo/"$(run_tools file_rw INFO Read "Timezone")" /etc/localtime &>/dev/null && hwclock --systohc --utc # å°†æ—¶åŒºæ›´æ”¹ä¸º"ä¸Šæµ·" / ç”Ÿæˆ /etc/adjtime
        run_tools run "Set the hostname \"$CONF_Hostname\"." 
    echo "$CONF_Hostname" > /etc/hostname
        run_tools run "Localization language settings."
    sed -i 's/#.*en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen
        run_tools run "Write 'en_US.UTF-8 UTF-8' To /etc/locale.gen."
    sed -i 's/#.*zh_CN.UTF-8 UTF-8/zh_CN.UTF-8 UTF-8/' /etc/locale.gen
        run_tools run "Write 'zh_CN.UTF-8 UTF-8' To /etc/locale.gen."
    locale-gen
        run_tools run "Configure local language defaults 'en_US.UTF-8'."; sleep 0.2
    echo "$language" > /etc/locale.conf       # ç³»ç»Ÿè¯­è¨€ "è‹±æ–‡" é»˜è®¤ä¸ºè‹±æ–‡   
}

# @Install/Configure virtualbox-guest-utils / open-vm-tools, å®‰è£…è™šæ‹ŸåŒ–æ’ä»¶
function install_virtualization_service(){
    CONF_PKG_VMWARE="$(run_tools file_rw CONF Read "PGK_Vmware")"
    CONF_PKG_VIRTUALBOX="$(run_tools file_rw CONF Read "PGK_VirtualBox")"
    case "$1" in
        Vmware)
            run_tools run "Install VMware workstation pro tools."
            Install_Program "$CONF_PKG_VMWARE"
            run_tools feed "vmware-tools installation successfully." "vmware-tools installation failed."

            systemctl enable vmtoolsd.service
            run_tools feed "vmtoolsd.service enable successfully." "vmtoolsd.service enable failed."

            systemctl enable vmware-vmblock-fuse.service
            run_tools feed "vmware-vmblock-fuse.service enable successfully." "vmware-vmblock-fuse.service enable failed."
            
            systemctl start vmtoolsd.service
            run_tools feed "vmtoolsd.service started successfully." "vmtoolsd.service started failed."
            
            systemctl start vmware-vmblock-fuse.service
            run_tools feed "vmware-vmblock-fuse.service started successfully." "vmware-vmblock-fuse.service started failed."
        ;;
        VirtualBox)
            run_tools run "Install VirtualBox tools."
            Install_Program "$CONF_PKG_VIRTUALBOX"
            run_tools feed "VirtualBox tools installation successfully." "VirtualBox tools installation failed."
            
            systemctl enable vboxservice.service
            run_tools feed "vboxservice.service enable successfully." "vboxservice.service enable failed."
            
            systemctl start vboxservice.service
            run_tools feed "vboxservice.service started successfully." "vboxservice.service started failed."
        ;;
        *) run_tools err "This computer is not virtualized."
    esac
}

# @Archlive update tips 
function Archiso_version_check(){
    Version_Route="${1}"
    TIME_ARCHISO=$(sed 's/\./-/g' "$Version_Route" 2> /dev/null)
    Time_interval=$((($(date +%s) - $(date -d "$TIME_ARCHISO 00:00:00" +%s)) / 2605391 ))
    run_tools file_rw INFO Write Archiso_version "${TIME_ARCHISO:- }";
    case $Time_interval in
        [0])    ;;
        [1])    echo; run_tools warn "Please update as soon as possible archiso ! "
                run_tools warn "Archiso Version: ${white}[ ${TIME_ARCHISO} ]${suffix}"
                ;;
        [2])    echo; run_tools warn "You haven't updated in more than 2 month archiso !" 
                run_tools warn "Archiso Version: ${white}[ ${TIME_ARCHISO} ]${suffix}"
                sleep 3
                ;;
        [3])    echo; run_tools warn "You haven't updated in more than 3 month archiso !"
                run_tools warn "Archiso Version: ${white}[ ${TIME_ARCHISO} ]${suffix}"
                run_tools tips_w "Whether to start the script [Y/n]?"
                    case $(run_tools read) in
                        [Yy]*)  sleep 1 ;;
                            *)  clear; warn "Please update archiso."; exit 30
                    esac ;;
        *)      echo; run_tools warn "Archiso Version: ${white}[ ${TIME_ARCHISO} ]${suffix}"
                run_tools warn "You haven't updated for a long time, Please update your archisoarchiso!!!"
                exit 30
    esac
}

# @å®‰è£…ç³»ç»Ÿ
function Installation_System(){
    INFO_Root_partition=$(run_tools file_rw INFO Read "Root_partition")  
    if [ -n "$INFO_Root_partition" ]; then  # åç»­å¾…ä¿®æ”¹éƒ¨åˆ†
        Install_Archlinux
    else
        run_tools process restart "$0" "${white}The partition is not mounted.${suffix}"
    fi
    run_print_info install_system_info 
    # Chrootåˆ°æ–°ç³»ç»Ÿä¸­å®ŒæˆåŸºç¡€é…ç½®
    cp -f /etc/pacman.conf $System_Root/etc/pacman.conf 
    cp -f /etc/pacman.d/mirrorlist $System_Root/etc/pacman.d/mirrorlist
    Auins_chroot
}

# @é…ç½®ç³»ç»Ÿ
function Configure_System(){
    set +e
    Disk_Kernel=$(cat /usr/src/linux/version)
    INFO_Install_Kernel=$(run_tools file_rw INFO Read "LinuxKernel")
    CONF_PGK_Terminal_Tools=$(run_tools file_rw CONF Read "PGK_Terminal_Tools")
    CONF_PKG_SystemctlFile=$(run_tools file_rw CONF Read "PKG_SystemctlFile")
    CONF_PGK_Common_Package=$(run_tools file_rw CONF Read "PGK_Common_Package")
    if [ -n "$INFO_Install_Kernel" ] || [ -n "$Disk_Kernel" ] ; then 
        Configure_Grub
        Configure_users2passwd
        echo;
        Configure_Language
        #---------------------------------------------------------------------------#
        run_tools run "Install the Terminal tools packages."
        Install_Program "$CONF_PGK_Terminal_Tools"
        run_tools feed "Terminal tools packages installation successfully." "Terminal tools packages installation failed."
        
        run_tools run "Install the System file package."
        Install_Program "$CONF_PKG_SystemctlFile"
        run_tools feed "System file package installation successfully." "System file package installation failed."
        
        run_tools run "Install the Other common package."
        Install_Program "$CONF_PGK_Common_Package"
        run_tools feed "Other common package installation successfully." "Other common package installation failed."

        run_tools run "Configure enable Network."
        systemctl enable NetworkManager
        run_tools feed "NetworkManager.service enable successfully." "NetworkManager.service enable failed."
        
        # åˆ é™¤è¿™ä¸ªæ–‡ä»¶ï¼Œæ‰èƒ½è¿› Normal_Mode
        rm -rf "$local_Dir"/Not_Configure_System 2> /dev/null   
        run_configure_fonts Config_file_install_fonts 

        if [ "$(run_tools file_rw CONF Read "Archlinucn")" = "yes" ]; then Install_Program archlinuxcn-keyring; fi
        run_tools feed "archlinuxcn-keyring installation successfully." "archlinuxcn-keyring installation failed."
    else
        run_tools process restart "$0" "${red}The system is not installed. Exec: 4->2 ${suffix}"
    fi 
    set -e
}

# @åˆ é™¤è„šæœ¬å’Œç¼“å­˜
function Auins_delete(){
    run_tools warn "Removing auins and cache!"
    pacman -Scc --clean
    rm -rfv "$modules_Dir"
    rm -rfv "$local_Dir"
    echo -e "\033[1;37m:: $(tput bold; tput setaf 2) Ê• áµ”á´¥áµ” Ê”  =>$(tput sgr0) Bye-bye~"
    rm -rf "$0"
}     

# @ Archiso LiveCD ä¸‹è‡ªåŠ¨å¯ç”¨
function LiveCD_Mode(){
    run_print_info logos "$CHROOT_PATTERNS_PRINT" "$START_MODE"
    # æ£€æŸ¥archisoç‰ˆæœ¬ï¼Œå¦‚æœè¿‡ä½ï¼Œå«æé†’æ›´æ–°
    if [[ $CHROOT_PATTERNS_PRINT == "Chroot-OFF" ]]; then
        CONF_Archiso_Version_check=$(run_tools file_rw CONF Read "Archiso_Version_check");
        case $CONF_Archiso_Version_check in [Yy]*) Archiso_version_check "$Livecd_Version_Route"; esac
    fi
    # è¾“å‡ºé¦–é¡µé€‰é¡¹åˆ—è¡¨
    run_print_info livecd_home_list;   
    echo -e "\n${Chroot_status:- }"
    # printf "${outG} ${yellow} Please enter${white}[1,2,3..]${yellow} Exit${white}[${red}Q${white}]${suffix} %s" "$inB"
    run_tools tips_w "Please enter[1,2,3..] Exit[Q]"
    case $(run_tools read) in
        1)  run_update_mirrors ;; # é…ç½®æº
        2)  Network Conf_all;; # é…ç½®ç½‘ç»œ
        3)  Open_SSH ;; # é…ç½®SSH
        4) # äºŒçº§åˆ—è¡¨ éš
            run_print_info livecd_system_module_list;
            echo -e "${input_System_Module_Chroot:- \n}"
            # printf "${outG} ${yellow} Please enter${white}[1,2,3,22..]${yellow} Exit${white}[${red}Q${white}]${suffix} %s" "$inB"
            run_tools tips_w "Please enter[1,2,3,22..] Exit[Q]"
            case $(run_tools read) in
                0)  Auins_chroot ;;
                1)  run_configure_partition ;; # ç£ç›˜åˆ†åŒº éš
                2)  Installation_System ;; # å®‰è£…ç³»ç»Ÿ éš 
                3)  # é…ç½®ç³»ç»Ÿ éš
                    # run_update_mirrors
                    Configure_System 
                    sleep 1.5;
                    run_print_info config_system_info ;; 
                4)  Configure_users2passwd ;;
                5)  # å®‰è£…æ¡Œé¢
                    Configure_users2passwd
                    run_configure_desktop ;; 
                11) run_configure_drive ;;  # å®‰è£…I/Oé©±åŠ¨
                22) install_virtualization_service "$Host_Environment"; bash "$0" ;; # å®‰è£…Vm tools
            esac ;;
        [Ss]*) bash ;;
        [Qq]* | *) run_tools process stop "$0" 
    esac
}

# @ å®‰è£…å®ŒArchlinuxå æ­£å¸¸å¯ç”¨æƒ…å†µä¸‹è‡ªåŠ¨å¯ç”¨
function Normal_Mode(){
    CONF_BlackArch=$(run_tools file_rw CONF Read "BlackArch")
    INFO_BlackArch=$(run_tools file_rw INFO Read "BlackArch")
    [[ $INFO_BlackArch == "" ]] && run_tools file_rw INFO Write BlackArch no
    [[ $CONF_BlackArch == "yes" &&  $INFO_BlackArch == "no" ]] && run_blarckarch_script

    run_print_info logos "$CHROOT_PATTERNS_PRINT" "$START_MODE"
    run_print_info normal_home_list;   
    echo -e "\n${Chroot_status:- }"
    # printf "${outG} ${yellow} Please enter${white}[1,2,3,22..]${yellow} Exit${white}[${red}Q${white}]${suffix} %s" "$inB"
    run_tools tips_w "Please enter[1,2,3,22..] Exit[Q]"
    case $(run_tools read) in
        1)  run_update_mirrors ;; # é…ç½®æº
        2)  Network Conf_all;; # é…ç½®ç½‘ç»œ
        3)  Open_SSH ;; # é…ç½®SSH
        4)  Configure_users2passwd ;;
        5)  # å®‰è£…æ¡Œé¢
            Configure_users2passwd
            run_configure_desktop ;;
        6)  run_configure_fonts "Script_Runing_install_fonts" ;;
        11) run_configure_drive;; # å®‰è£…I/Oé©±åŠ¨
        22) install_virtualization_service "$Host_Environment" ;; # å®‰è£…Vm tools
        [Dd]) Auins_delete ;;
        [Ss]*) bash ;;
        [Qq]* | *) run_tools process stop "$0" 
    esac
}

# @Auinsçš„å…¶ä»–é€‰é¡¹åŠŸèƒ½
function Auins_Options(){
    function archiso_version_check_warn(){
        case $1 in 
            enable ) 
                    run_tools file_rw CONF Write Archiso_Version_check "yes" 
                    run_tools feed "Enable: Always check the archiso version." "enable failed." ;;
            disable) 
                    run_tools file_rw CONF Write Archiso_Version_check "no"
                    run_tools feed "Disable: Do not check archiso version." "disable failed." ;;
                    *) 
                    run_tools err "This option was not found $1"
        esac
    }
    function auins_update(){
        case $1 in 
            enable ) 
                    run_tools file_rw CONF Write Now_update_auins "yes" 
                    run_tools feed "Enable: Always Auins update." "enable failed." ;;
            disable) 
                    run_tools file_rw CONF Write Now_update_auins "no"
                    run_tools feed "Disable: Always turn off Auins update." "disable failed." ;;
                    *) 
                    run_tools err "This option was not found $1"
        esac
    }
    case "${1}" in
# Install Commands: ("-S = install", "-R = uninstall")
        font ) 
                run_configure_fonts User_options_install_fonts "$2" 
                exit 0 ;;
        fcitx) 
                Configure_fcitx "$2" 
                exit 0 ;;
        ibus ) 
                Configure_ibus_rime "$2" 
                exit 0 ;;
        axel ) 
                Axel_Configure "$2" 
                exit 0 ;;
        inGpu) 
                run_tools warn "Functional improvement in progress..." 
                exit 0 ;;
        inVmt) 
                install_virtualization_service "$Host_Environment"
                exit 0 ;;
        black) 
                run_blarckarch_script
                exit 0 ;; 
# Settings Options:
        -m | --mirror ) 
                        run_update_mirrors 
                        exit 0 ;;
        -w | --wifi   ) 
                        Network Conf_wifi 
                        exit 0 ;;
        -s | --openssh) 
                        case "$CONF_Service_SSH" in
                            yes) 
                                run_tools skip "activate." ;;
                            *  )  
                                Open_SSH
                        esac
                        exit 0  ;;
# Global Options:
            --update    )   
                            auins_update "$2"
                            exit 0  ;;
            --iso-check )   
                            archiso_version_check_warn "$2"
                            exit 0  ;;
        -e | --edit-conf) 
                            vim "${config_File}" 
                            exit 0 ;;
        -f | --show-conf) 
                            less "${config_File}" 
                            exit 0 ;;
        -i | --show-info) 
                            clear; less "${info_File}" 
                            exit 0 ;;
        -c | --clean-cache) 
                            Auins_delete 
                            exit 0 ;;
        -h | --help     ) 
                            run_print_info auins_usage 
                            exit 0 ;;
        -v | --version  ) 
                            run_print_info version 
                            exit 0 ;;
        [Aa]uins        ) 
                            clear 
                            echo -e "${white}${0##*/}: Thank you for your use. I look forward to not letting you down.${suffix}"; 
                            exit 0 ;;
                        *) 
                            case_return=10 ;;
        # --versions        ) echo "$AUINS_VERSION" | awk -F "v" '{print $NF}' | sed 's/\.//g' | sed 's/-\([a-z][a-z]\+\)//g';
    esac
    if [ "$case_return" = 10 ] && [[ "$1" != "" ]] ; then
        run_print_info auins_usage; run_tools err "This option was not found: $*"
    fi
}

# @è¯¥æ­»çš„é¢œè‰²
function Set_Color_Variable(){
    # çº¢ ç»¿ é»„ è“ ç™½ åç¼€
    red='\033[1;31m'; green='\033[1;32m'  
    yellow='\033[1;33m'; blue='\033[1;36m'  
    white='\033[1;37m'; suffix='\033[0m'     
    #-----------------------------#
    # rw='\033[1;41m'  #--çº¢ç™½
    wg='\033[1;42m'; # ws='\033[1;43m'      #ç™½ç»¿ \ ç™½è¤
    #wb='\033[1;44m'; wq='\033[1;45m'    #ç™½è“ \ ç™½ç´«
    # wa='\033[1;46m';   #ç™½é’ \ 
    # bx='\033[1;4;36m'; # ä¸‹åˆ’çº¿ è“
    #-----------------------------
    # æç¤º ç»¿ é»„
    outG="${white}::${green} =>${suffix}"; outY="${white}::${yellow} =>${suffix}"
}

# Start Script | ä»è¿™é‡Œå¼€å§‹
# >> >> >> >> >> >> >> >> >> >> >> >> 
check_priv
Auins_Variable_init
Set_Color_Variable
Update_Share auins_download_url "$SCRIPTS_SOURCE"  # é”å®šè„šæœ¬ä¸‹è½½æº
Update_Share download_script        # ä¸‹è½½è„šæœ¬éœ€è¦çš„è„šæœ¬
Network ethernet_info
Script_init
Auins_Options "$1" "$2" 
# å…·ä½“çš„å®ç°ChrootPatterns
# exec_mode $CHROOT_PATTERNS_PRINT
case "$CHROOT_PATTERNS_PRINT" in 
        Chroot-OFF)
            Chroot_status="${white}::${SHOW_Host_Env} ${green}=> ${yellow}Not Chroot.${suffix}"
            input_System_Module_Chroot="${outY} \t${white}[${yellow}0${white}]${yellow}  arch-chroot ${System_Root}     \t\t${red}**${suffix}\n"
            [ -e $System_Root/root/local/Chroot_ON ] && Auins_chroot 2> /dev/null; 
            START_MODE="LiveCD"
            LiveCD_Mode
        ;;
        Chroot-ON) 
            Chroot_status="${outG}  ${wg}Successfully start: Chroot.${suffix}"
            if [ -e "$local_Dir"/Not_Configure_System ]; then 
                START_MODE="LiveCD"
                LiveCD_Mode
            else 
                START_MODE="Normal"
                Normal_Mode
            fi
    esac
# >> >> >> >> >> >> >> >> >> >> >> >>
# @å¾…è§£å†³çš„é—®é¢˜ 
: << EOF
    - [ ] ğŸ’»æ–°å¢: (v4.5)å¿«ç…§å¤‡ä»½è½¯ä»¶(timeshift)ï¼Œå¼€å¯æ–¹å¼ï¼šé…ç½®æ–‡ä»¶ï¼Œé»˜è®¤å¼€å¯
    - [ ] ğŸ’»è„šæœ¬ï¼š[v5.0]Beta s2arch.sh Archlinux can be installed on VPS
    - [ ] â³  å°è¯•åŠ å…¥Waylandçš„æ¡Œé¢ç¯å¢ƒï¼Œæ¯”å¦‚ï¼šSwayï¼ŒPlasma-Waylandç­‰ç­‰
    - [ ] â³  ä¼šç»§ç»­å°è¯•DWMæ¡Œé¢ç¯å¢ƒ
    - [ ] â³  ä¼šå°è¯•ç»´æŠ¤Openboxæ¡Œé¢ç¯å¢ƒ
EOF